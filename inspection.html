<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qiddiya Resort Core District</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* --- styles unchanged --- */
.footer {
  margin-top: 22px;
  padding-top: 14px;
  border-top: 1px solid #eee;
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  font-weight: 300;
}
.footer a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 400;
}
.footer a:hover { text-decoration: underline; }

:root {
  --primary: #294145;
  --secondary: #5D855E;
  --accent: #86B85E;
  --light: #E6F0DE;
  --muted: #666666;
  --white: #FFFFFF;
  --bg: #F9F9F9;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: "Oswald", sans-serif;
  background:
    radial-gradient(circle at top left, var(--light), transparent 60%),
    radial-gradient(circle at bottom right, #dfeee0, transparent 55%),
    var(--bg);
  min-height: 100vh;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: 620px;
  background: var(--white);
  padding: 28px;
  border-radius: 18px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.08);
}

.header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 10px;
}
.header img { width: 110px; }

.titles { text-align: center; margin-bottom: 28px; }
.title { font-size: 26px; font-weight: 500; color: var(--primary); }
.subtitle { font-size: 15px; color: var(--muted); font-weight: 300; }

.info {
  background: var(--light);
  color: var(--primary);
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 20px;
  text-align: center;
}

.section {
  margin-top: 22px;
  padding: 18px;
  background: #F9F9F9;
  border-radius: 14px;
  border: 1px solid #eee;
}

.section-title {
  font-size: 15px;
  font-weight: 500;
  color: var(--primary);
  margin-bottom: 14px;
}

form label {
  display: block;
  margin-bottom: 14px;
  font-size: 14px;
}

form input {
  width: 100%;
  padding: 14px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1.5px solid #ddd;
}

button {
  margin-top: 28px;
  padding: 15px;
  width: 100%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff;
  font-size: 16px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
}

.message { margin-top: 16px; text-align: center; }
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <img src="https://infinitehse.com/wp-content/uploads/2026/01/IES_logo_with_Qiddiya-removebg.png">
  </div>

  <div class="titles">
    <div class="title">Qiddiya Resort Core District</div>
    <div class="subtitle">Weekly Site Environmental Inspection</div>
  </div>

  <div class="info" id="locationInfo">Detecting location...</div>

  <form id="inspectionForm">
    <input type="hidden" id="point">
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">

    <div class="section">
      <div class="section-title">Noise Levels (dB)</div>
      <label>LAeq <input type="number" step="0.1" id="LAeq" required></label>
      <label>LA90 <input type="number" step="0.1" id="LA90" required></label>
      <label>LA10 <input type="number" step="0.1" id="LA10" required></label>
      <label>LAmax <input type="number" step="0.1" id="LAmax" required></label>
      <label>LAmin <input type="number" step="0.1" id="LAmin" required></label>
    </div>

    <div class="section">
      <div class="section-title">Particulate Matter</div>
      <label>PM10 <input type="number" step="0.1" id="PM10" required></label>
      <label>PM2.5 <input type="number" step="0.1" id="PM25" required></label>
    </div>

    <button type="submit" id="submitBtn">Submit</button>
    <div class="message" id="formMessage"></div>
  </form>

  <div class="footer">
    Developed by <a href="https://infinitehse.com/" target="_blank">Infinite HSE</a>
  </div>
</div>

<script>
const points = [
  {id:"Point #1",lat:24.57575,lng:46.31689},
  {id:"Point #2",lat:24.57753,lng:46.32825},
  {id:"Point #3",lat:24.58586,lng:46.33322},
  {id:"Point #4",lat:24.58583,lng:46.33642},
  {id:"Point #5",lat:24.59058,lng:46.34292},
  {id:"Point #6",lat:24.59225,lng:46.33586},
  {id:"Point #7",lat:24.59092,lng:46.32689},
  {id:"Point #8",lat:24.58947,lng:46.32022},
  {id:"Point #9",lat:24.58919,lng:46.31094},
  {id:"Point #10",lat:24.57600,lng:46.30837}
];

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function detectPoint(lat, lng) {
  let nearest = null;
  let minDist = Infinity;

  for (let p of points) {
    const d = getDistance(lat, lng, p.lat, p.lng);
    if (d < minDist) {
      minDist = d;
      nearest = p;
    }
  }

  // Max distance threshold (meters)
  if (minDist > 100) return null; // too far ‚Üí Unknown
  return nearest;
}

/* üîë FORCE LOCATION UPDATE FUNCTION */
function updateLocation() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;

        document.getElementById("lat").value = latitude;
        document.getElementById("lng").value = longitude;

        const p = detectPoint(latitude, longitude);
        document.getElementById("point").value = p ? p.id : "Unknown Point";

        document.getElementById("locationInfo").innerText = p
          ? `üìç ${p.id} detected`
          : `‚ö†Ô∏è Unknown location (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;

        resolve();
      },
      () => {
        document.getElementById("locationInfo").innerText =
          "‚ö†Ô∏è Location not available";
        reject();
      },
      {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      }
    );
  });
}

/* INITIAL LOCATION */
updateLocation();

/* SUBMIT */
document.getElementById("inspectionForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  const msg = document.getElementById("formMessage");

  btn.disabled = true;
  btn.innerText = "Sending...";

  try {
    await updateLocation(); // ‚úÖ FORCE UPDATE BEFORE SEND

    const data = {
      point: point.value,
      lat: lat.value,
      lng: lng.value,
      LAeq: LAeq.value,
      LA90: LA90.value,
      LA10: LA10.value,
      LAmax: LAmax.value,
      LAmin: LAmin.value,
      PM10: PM10.value,
      PM25: PM25.value
    };

    const res = await fetch("https://script.google.com/macros/s/AKfycbw_BboAEESwnwikl7KQTM04nJLQUEv18WUHoQVv-v-COwklaf0um5Ekgz6YxZ4d48bhtw/exec", {
      method: "POST",
      body: JSON.stringify(data)
    });

    const result = await res.json();
    msg.innerText = result.result === "success"
      ? "‚úÖ Data submitted successfully"
      : "‚ùå Submission failed";
  } catch {
    msg.innerText = "‚ùå Location error";
  }

  btn.disabled = false;
  btn.innerText = "Submit";
});
</script>
</body>
</html>
